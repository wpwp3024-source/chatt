<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Chat</title>
<style>
body, html {margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#ece5dd;}
.modal {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999;}
.modal-content {background:#fff; padding:20px; border-radius:10px; text-align:center; width:80%; max-width:350px;}
.modal input {width:80%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ccc;}
.modal button {margin-top:10px; padding:10px 20px; border:none; border-radius:5px; background:#128c7e; color:#fff; cursor:pointer;}

.chat-container {display:none; flex-direction:column; height:100vh;}
.messages {flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column;}
.message {max-width:70%; margin:5px 0; padding:10px; border-radius:10px; word-wrap:break-word;}
.me {background:#dcf8c6; align-self:flex-end;}
.other {background:#fff; align-self:flex-start;}
.input-area {display:flex; padding:5px; background:#fff; align-items:center; gap:5px; flex-wrap:wrap;}
.input-area input[type=text] {flex:1; padding:10px; border:1px solid #ccc; border-radius:20px;}
.input-area button {padding:10px; border:none; border-radius:20px; background:#128c7e; color:#fff; cursor:pointer; flex-shrink:0;}
#emojiPicker {display:none; position:absolute; bottom:60px; left:10px; background:#fff; border:1px solid #ccc; padding:5px; border-radius:5px; z-index:1000;}
#emojiPicker span {font-size:24px; padding:5px; cursor:pointer;}
.message img {max-width:200px; border-radius:8px; margin-top:5px;}
.message audio {margin-top:5px; width:100%;}
</style>
</head>
<body>

<!-- Kullanıcı adı modal -->
<div id="usernameModal" class="modal">
  <div class="modal-content">
    <h3>Kullanıcı adını gir</h3>
    <input type="text" id="usernameInput" placeholder="Adın..."/>
    <br>
    <button id="saveUsername">Başla</button>
  </div>
</div>

<div class="chat-container" id="chatContainer">
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <button id="emojiBtn">😊</button>
    <input type="text" id="msgInput" placeholder="Mesaj yaz..." />
    <button id="recordBtn">🎤</button>
    <input type="file" id="photoInput" accept="image/*" style="display:none;">
    <button id="photoBtn">📷</button>
    <button id="sendBtn">Gönder</button>
    <div id="emojiPicker">
      <span>😀</span><span>😂</span><span>😍</span><span>😎</span><span>😢</span><span>👍</span><span>🙏</span>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD2L8HMfaX7CQyq018gYILH4gavT929PCA",
  authDomain: "birebir-16813.firebaseapp.com",
  projectId: "birebir-16813",
  storageBucket: "birebir-16813.firebasestorage.app",
  messagingSenderId: "1054525917122",
  appId: "1:1054525917122:web:27a7ea9cde7bf035c5385b",
  measurementId: "G-PX4GQDZ6KD"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage();
const messagesRef = collection(db, "messages");
const q = query(messagesRef, orderBy("createdAt"));

// DOM
const usernameModal = document.getElementById("usernameModal");
const usernameInput = document.getElementById("usernameInput");
const saveUsernameBtn = document.getElementById("saveUsername");
const chatContainer = document.getElementById("chatContainer");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const emojiBtn = document.getElementById("emojiBtn");
const emojiPicker = document.getElementById("emojiPicker");
const recordBtn = document.getElementById("recordBtn");
const photoBtn = document.getElementById("photoBtn");
const photoInput = document.getElementById("photoInput");

let username = localStorage.getItem("chatUsername") || "";
let mediaRecorder, audioChunks=[], recording=false;

// Modal kontrol
function showChat(){
  usernameModal.style.display="none";
  chatContainer.style.display="flex";
}
if(username) showChat(); else usernameModal.style.display="flex";

saveUsernameBtn.addEventListener("click", ()=>{
  const val = usernameInput.value.trim();
  if(val){ username=val; localStorage.setItem("chatUsername", username); showChat(); }
  else alert("Lütfen geçerli bir ad girin.");
});

// Emoji picker
emojiBtn.addEventListener("click", ()=>emojiPicker.style.display = emojiPicker.style.display==="none"?"block":"none");
document.querySelectorAll("#emojiPicker span").forEach(el=>{
  el.addEventListener("click", ()=>{
    msgInput.value += el.textContent;
    emojiPicker.style.display="none";
    msgInput.focus();
  });
});

// Text mesaj gönderme (Enter tuşu dahil)
async function sendText(e){
  if(e) e.preventDefault();
  const text = msgInput.value.trim();
  if(!text) return;
  await addDoc(messagesRef, {text, user:username, createdAt:serverTimestamp()});
  msgInput.value="";
}
sendBtn.addEventListener("click", sendText);
msgInput.addEventListener("keydown", e=>{ if(e.key === "Enter") sendText(e); });

// Fotoğraf gönderme
photoBtn.addEventListener("click", ()=>photoInput.click());
photoInput.addEventListener("change", async e=>{
  const file = e.target.files[0]; if(!file) return;
  const fileRef = ref(storage, `images/${username}_${Date.now()}_${file.name}`);
  await uploadBytes(fileRef, file);
  const url = await getDownloadURL(fileRef);
  await addDoc(messagesRef, {user:username, imageURL:url, createdAt:serverTimestamp()});
  photoInput.value="";
});

// Ses kaydı: bas ve bırak ile gönder
function startRecording(stream){
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();
  recordBtn.textContent = "⏹ Kayıt";
}

async function stopRecording(){
  if(!mediaRecorder) return;
  mediaRecorder.stop();
  recordBtn.textContent = "🎤";
  mediaRecorder.onstop = async ()=>{
    try{
      const audioBlob = new Blob(audioChunks,{type:"audio/webm"});
      const fileRef = ref(storage, `audio/${username}_${Date.now()}.webm`);
      await uploadBytes(fileRef,audioBlob);
      const url = await getDownloadURL(fileRef);
      await addDoc(messagesRef,{user:username, audioURL:url, createdAt:serverTimestamp()});
      // Son 20 ses kontrolü
      const snap = await getDocs(query(messagesRef,orderBy("createdAt")));
      const userAudio = snap.docs.filter(doc=>doc.data().user===username && doc.data().audioURL);
      if(userAudio.length>20){
        const oldest = userAudio[0];
        const path = decodeURIComponent(oldest.data().audioURL.split("/o/")[1].split("?")[0]);
        const oldRef = ref(storage,path);
        await deleteObject(oldRef).catch(()=>{});
        await deleteDoc(oldest.ref);
      }
    }catch(e){console.error("Ses gönderilemedi:",e);}
  };
}

// Mouse & Touch events
recordBtn.addEventListener("mousedown", async ()=>{
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  startRecording(stream);
});
recordBtn.addEventListener("mouseup", stopRecording);
recordBtn.addEventListener("touchstart", async e=>{
  e.preventDefault();
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  startRecording(stream);
});
recordBtn.addEventListener("touchend", async e=>{
  e.preventDefault();
  await stopRecording();
});

// Realtime mesajları dinle
onSnapshot(q, snapshot=>{
  messagesDiv.innerHTML="";
  snapshot.forEach(doc=>{
    const msg = doc.data();
    const div = document.createElement("div");
    div.classList.add("message", msg.user===username?"me":"other");
    if(msg.text) div.innerText = msg.user+": "+msg.text;
    if(msg.imageURL){
      const img = document.createElement("img");
      img.src = msg.imageURL;
      div.appendChild(img);
    }
    if(msg.audioURL){
      const audio = document.createElement("audio");
      audio.src = msg.audioURL;
      audio.controls=true;
      div.appendChild(audio);
    }
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>
</body>
</html>
