<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Chat</title>
<style>
body, html {
  margin:0;
  padding:0;
  height:100%;
  font-family:Arial,sans-serif;
  background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed;
  background-size: cover;
}

.modal {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal-content {
  background:#fff;
  padding:20px;
  border-radius:10px;
  text-align:center;
  width:80%;
  max-width:350px;
}
.modal input {
  width:80%;
  padding:10px;
  margin-top:10px;
  border-radius:5px;
  border:1px solid #ccc;
}
.modal button {
  margin-top:10px;
  padding:10px 20px;
  border:none;
  border-radius:5px;
  background:#128c7e;
  color:#fff;
  cursor:pointer;
}

.chat-container {
  display:none;
  flex-direction:column;
  height:100vh;
}
.messages {
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
}
.message {
  max-width:70%;
  margin:5px 0;
  padding:10px;
  border-radius:10px;
  word-wrap:break-word;
}
.me {background:#dcf8c6; align-self:flex-end;}
.other {background:#fff; align-self:flex-start;}
.message img {
  max-width:200px;
  border-radius:8px;
  margin-top:5px;
}
.input-area {
  display:flex;
  padding:5px;
  background:#fff;
  align-items:center;
  gap:5px;
  position:sticky;
  bottom:0;
}
.input-area input[type=text] {
  flex:1;
  padding:10px;
  border:1px solid #ccc;
  border-radius:20px;
}
.input-area button {
  padding:10px;
  border:none;
  border-radius:20px;
  background:#128c7e;
  color:#fff;
  cursor:pointer;
  flex-shrink:0;
}

/* GIF panel */
.gif-modal {
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%, -50%);
  background:#fff;
  padding:15px;
  border-radius:10px;
  display:none;
  z-index:10000;
  max-width:500px;
  width:90%;
  max-height:80%;
  overflow-y:auto;
}
.gif-modal-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.gif-modal-header input {
  flex:1;
  padding:5px;
  margin-right:10px;
  border-radius:5px;
  border:1px solid #ccc;
}
.gif-close {
  cursor:pointer;
  font-size:20px;
  font-weight:bold;
}
.gif-grid {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}
.gif-grid img {
  width:80px;
  height:80px;
  cursor:pointer;
  border-radius:8px;
  object-fit:cover;
}
</style>
</head>
<body>

<!-- Kullanıcı adı modal -->
<div id="usernameModal" class="modal">
  <div class="modal-content">
    <h3>Kullanıcı adını gir</h3>
    <input type="text" id="usernameInput" placeholder="Adın..."/>
    <br>
    <button id="saveUsername">Başla</button>
  </div>
</div>

<div class="chat-container" id="chatContainer">
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input type="text" id="msgInput" placeholder="Mesaj yaz..." />
    <button id="sendBtn">Gönder</button>
    <button id="gifBtn">GIF</button>
  </div>
</div>

<!-- GIF panel -->
<div id="gifModal" class="gif-modal">
  <div class="gif-modal-header">
    <input type="text" id="gifSearch" placeholder="GIF ara..." />
    <span id="gifClose" class="gif-close">&times;</span>
  </div>
  <div class="gif-grid" id="gifGrid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD2L8HMfaX7CQyq018gYILH4gavT929PCA",
  authDomain: "birebir-16813.firebaseapp.com",
  projectId: "birebir-16813",
  storageBucket: "birebir-16813.appspot.com",
  messagingSenderId: "1054525917122",
  appId: "1:1054525917122:web:27a7ea9cde7bf035c5385b",
  measurementId: "G-PX4GQDZ6KD"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const messagesRef = collection(db, "messages");
const q = query(messagesRef, orderBy("createdAt"));

// DOM
const usernameModal = document.getElementById("usernameModal");
const usernameInput = document.getElementById("usernameInput");
const saveUsernameBtn = document.getElementById("saveUsername");
const chatContainer = document.getElementById("chatContainer");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const gifBtn = document.getElementById("gifBtn");
const gifModal = document.getElementById("gifModal");
const gifGrid = document.getElementById("gifGrid");
const gifSearch = document.getElementById("gifSearch");
const gifClose = document.getElementById("gifClose");

let username = localStorage.getItem("chatUsername") || "";

// Modal kontrol
function showChat(){
  usernameModal.style.display="none";
  chatContainer.style.display="flex";
}
if(username) showChat(); else usernameModal.style.display="flex";

saveUsernameBtn.addEventListener("click", ()=>{
  const val = usernameInput.value.trim();
  if(val){ username=val; localStorage.setItem("chatUsername", username); showChat(); }
  else alert("Lütfen geçerli bir ad girin.");
});

// Text mesaj gönderme
async function sendText(e){
  if(e) e.preventDefault();
  const text = msgInput.value.trim();
  if(!text) return;
  await addDoc(messagesRef, {text, user:username, createdAt:serverTimestamp()});
  msgInput.value="";
}
sendBtn.addEventListener("click", sendText);
msgInput.addEventListener("keydown", e=>{ if(e.key === "Enter") sendText(e); });

// Giphy API (public beta key)
const giphyApiKey = "dc6zaTOxFJmzC"; // demo key
async function fetchGIFs(query="funny", limit=25){
  const res = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${giphyApiKey}&q=${encodeURIComponent(query)}&limit=${limit}`);
  const data = await res.json();
  return data.data.map(g=>g.images.fixed_height_small.url);
}

// GIF panel aç/kapat
gifBtn.addEventListener("click", async ()=>{
  gifModal.style.display="block";
  loadGIFs();
});
gifClose.addEventListener("click", ()=>{ gifModal.style.display="none"; });

// GIF arama
gifSearch.addEventListener("keydown", async e=>{
  if(e.key === "Enter"){
    loadGIFs(gifSearch.value.trim() || "funny");
  }
});

async function loadGIFs(searchTerm="funny"){
  gifGrid.innerHTML = "";
  const urls = await fetchGIFs(searchTerm, 25);
  urls.forEach(url=>{
    const img = document.createElement("img");
    img.src = url;
    img.addEventListener("click", async ()=>{
      await addDoc(messagesRef, {user:username, gifURL:url, createdAt:serverTimestamp()});
      gifModal.style.display="none";
    });
    gifGrid.appendChild(img);
  });
}

// Realtime mesajları dinle
onSnapshot(q, snapshot=>{
  messagesDiv.innerHTML="";
  snapshot.forEach(doc=>{
    const msg = doc.data();
    const div = document.createElement("div");
    div.classList.add("message", msg.user===username?"me":"other");
    if(msg.text) div.innerText = msg.user+": "+msg.text;
    if(msg.gifURL){
      const img = document.createElement("img");
      img.src = msg.gifURL;
      div.appendChild(img);
    }
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>
</body>
</html>
