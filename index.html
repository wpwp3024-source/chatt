<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Chat</title>
<style>
body, html {
  margin:0;
  padding:0;
  height:100%;
  font-family:Arial,sans-serif;
  background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed;
  background-size: cover;
}

.chat-container {
  display:flex;
  flex-direction:column;
  height:100vh;
}

.messages {
  flex:1;
  overflow-y:auto;
  padding:10px;
  padding-bottom:70px; /* input alanının üstüne gelmesi için boşluk */
  display:flex;
  flex-direction:column;
}

.message {
  max-width:70%;
  margin:5px 0;
  padding:10px;
  border-radius:10px;
  word-wrap:break-word;
}

.me {background:#dcf8c6; align-self:flex-end;}
.other {background:#fff; align-self:flex-start;}

.message img {
  max-width:200px;
  border-radius:8px;
  margin-top:5px;
}

.input-area {
  display:flex;
  padding:5px;
  background:#fff;
  align-items:center;
  gap:5px;
  box-sizing:border-box;
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  z-index: 100;
}

.input-area input[type=text] {
  flex:1;
  padding:10px;
  border:1px solid #ccc;
  border-radius:20px;
}

.input-area button {
  padding:10px 15px;
  border:none;
  border-radius:20px;
  background:#128c7e;
  color:#fff;
  cursor:pointer;
}

/* GIF seçenek popup */
.gif-options {
  position:absolute;
  bottom:60px;
  right:5px;
  background:#fff;
  border-radius:10px;
  padding:5px;
  display:none;
  flex-direction:column;
  gap:5px;
  z-index:1000;
}
.gif-options button {
  padding:8px 12px;
  border:none;
  border-radius:8px;
  background:#128c7e;
  color:#fff;
  cursor:pointer;
}

/* GIF modal */
.gif-modal {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.gif-modal-content {
  background:#fff;
  width:90%;
  max-width:400px;
  max-height:80%;
  overflow:auto;
  border-radius:10px;
  padding:15px;
  text-align:center;
}

.gif-grid {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}

.gif-grid img {
  width:80px;
  height:80px;
  cursor:pointer;
  border-radius:8px;
  object-fit:cover;
}

.gif-modal-content button {
  margin-top:10px;
  padding:8px 15px;
  border:none;
  border-radius:8px;
  background:#128c7e;
  color:#fff;
  cursor:pointer;
}

/* Kullanıcı adı modal */
#usernameModal {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
#usernameModal .gif-modal-content {
  max-width:300px;
}

/* Ayarlar modal */
#settingsModal {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10001;
}
#settingsModal .gif-modal-content {
  max-width:300px;
}
</style>
</head>
<body>

<!-- Kullanıcı adı modal -->
<div id="usernameModal">
  <div class="gif-modal-content">
    <h4>Kullanıcı adını gir</h4>
    <input type="text" id="usernameInput" placeholder="Adınız...">
    <br>
    <button id="saveUsername">Kaydet ve Başla</button>
  </div>
</div>

<div class="chat-container" id="chatContainer">
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input type="text" id="msgInput" placeholder="Mesaj yaz..." />
    <button id="sendBtn">Gönder</button>
    <button id="gifBtn">GIF</button>
  </div>
</div>

<!-- GIF seçenek popup -->
<div class="gif-options" id="gifOptions">
  <button id="funGifBtn">Eğlenceli GIF</button>
  <button id="specialBtn">Özel GIF</button>
</div>

<!-- GIF modal -->
<div class="gif-modal" id="gifModal">
  <div class="gif-modal-content">
    <h4>GIF Seç</h4>
    <div class="gif-grid" id="gifGrid"></div>
    <button id="gifCloseBtn">Kapat</button>
  </div>
</div>

<!-- Özel GIF şifre modal -->
<div class="gif-modal" id="specialPassModal">
  <div class="gif-modal-content">
    <h4>Özel GIF Şifresi</h4>
    <input type="text" id="specialPassInput" placeholder="Şifreyi gir">
    <br>
    <button id="specialPassBtn">Onayla</button>
    <button id="specialPassClose">Kapat</button>
  </div>
</div>

<!-- Ayarlar modalı -->
<div id="settingsModal">
  <div class="gif-modal-content">
    <h4>Ayarlar</h4>
    <label>
      <input type="checkbox" id="notifToggle" checked> Bildirim sesi açık
    </label>
    <br><br>
    <button id="settingsClose">Kapat</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD2L8HMfaX7CQyq018gYILH4gavT929PCA",
  authDomain: "birebir-16813.firebaseapp.com",
  projectId: "birebir-16813",
  storageBucket: "birebir-16813.appspot.com",
  messagingSenderId: "1054525917122",
  appId: "1:1054525917122:web:27a7ea9cde7bf035c5385b",
  measurementId: "G-PX4GQDZ6KD"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const messagesRef = collection(db, "messages");
const q = query(messagesRef, orderBy("createdAt"));

// DOM
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const gifBtn = document.getElementById("gifBtn");
const gifOptions = document.getElementById("gifOptions");
const funGifBtn = document.getElementById("funGifBtn");
const specialBtn = document.getElementById("specialBtn");
const gifModal = document.getElementById("gifModal");
const gifGrid = document.getElementById("gifGrid");
const gifCloseBtn = document.getElementById("gifCloseBtn");
const specialPassModal = document.getElementById("specialPassModal");
const specialPassInput = document.getElementById("specialPassInput");
const specialPassBtn = document.getElementById("specialPassBtn");
const specialPassClose = document.getElementById("specialPassClose");
const usernameModal = document.getElementById("usernameModal");
const usernameInput = document.getElementById("usernameInput");
const saveUsernameBtn = document.getElementById("saveUsername");

const settingsModal = document.getElementById("settingsModal");
const notifToggle = document.getElementById("notifToggle");
const settingsClose = document.getElementById("settingsClose");

let username = localStorage.getItem("chatUsername") || "";
let notifEnabled = true;

// Modal kontrolü
if(username){
  usernameModal.style.display="none";
} else {
  usernameModal.style.display="flex";
}

saveUsernameBtn.addEventListener("click", ()=>{
  const val = usernameInput.value.trim();
  if(val){
    username = val;
    localStorage.setItem("chatUsername", username);
    usernameModal.style.display="none";
  } else alert("Lütfen geçerli bir ad girin!");
});

// GIF listeleri
const funGifs = [
"https://media.giphy.com/media/l0Exk8EUzSLsrErEQ/giphy.gif","https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif",
"https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/giphy.gif","https://media.giphy.com/media/26xBJu2d3vLb86rWM/giphy.gif",
"https://media.giphy.com/media/l41lFw057lAJQMwg0/giphy.gif","https://media.giphy.com/media/l0HlNQ03J5JxX6lva/giphy.gif",
"https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif","https://media.giphy.com/media/xT0xeJpnrWC4XWblEk/giphy.gif",
"https://media.giphy.com/media/26ufdipQqU2lhNA4g/giphy.gif","https://media.giphy.com/media/l1J9EdzfOSgfyueLm/giphy.gif"
];

const specialGifs = [
  "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZWd3b3FwN2Y3ZjFrMGFyOHFkczQxb2hzMnpzbzFqbzRzbW95cW15dyZlcD12MV9naWZzX3NlYXJjaCZjdD1n/veAy5UOhBdS3C/giphy.gif",
  "https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3cmJyaXl4ZmFzYmI0YXhtbjBuYjBpYWhjcG95dDN1cmFrMXF1Y2V4byZlcD12MV9naWZzX3NlYXJjaCZjdD1n/tB0P33Am1oZck/giphy.gif",
  "https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3cmJyaXl4ZmFzYmI0YXhtbjBuYjBpYWhjcG95dDN1cmFrMXF1Y2V4byZlcD12MV9naWZzX3NlYXJjaCZjdD1n/of7ly2wRNo6Kk/giphy.gif",
  "https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3a2VwZTdlNWZtMnU3ajk2OHhtbHo2OXgyaG1wb3A2cW14eWxoZjN3eCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/ZqihO0jGDKc8SJYmRB/giphy.gif",
  "https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3bm1hZjdwYTFraDNpYzEwZXVva3owYjlkYmpnMmlnbzl2OWFodGwxeCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/vVzfZLROJZ2LK/giphy.gif",
  "https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3azd2ZzFhM2E4cHF2d2Q5MXhmZmwzMWZtY3hqNmEyMDRhcmF0YXFiMCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/C23q4oydK7Xva/giphy.gif",
  "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDBwNjY3cXBwYmgxMnpqbnBlbDU2ZXQ2dDdtNDJzNnRxNXlhcm03NiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/426FJ0tfyW316/giphy.gif"
];

// Mesaj gönderme
async function sendText(e){
  if(e) e.preventDefault();
  const text = msgInput.value.trim();
  if(!text) return;
  await addDoc(messagesRef,{text,user:username,createdAt:serverTimestamp()});
  msgInput.value="";
}
sendBtn.addEventListener("click", sendText);
msgInput.addEventListener("keydown", e=>{ if(e.key==="Enter") sendText(e); });

// GIF seçenek aç/kapa
gifBtn.addEventListener("click", ()=>{ gifOptions.style.display = gifOptions.style.display==="flex"?"none":"flex"; });

// Eğlenceli GIF
funGifBtn.addEventListener("click", ()=>{
  gifOptions.style.display="none";
  gifGrid.innerHTML="";
  funGifs.forEach(url=>{
    const img=document.createElement("img");
    img.src=url;
    img.addEventListener("click", async ()=>{
      await addDoc(messagesRef,{user:username,gifURL:url,createdAt:serverTimestamp()});
      gifModal.style.display="none";
    });
    gifGrid.appendChild(img);
  });
  gifModal.style.display="flex";
});

// Özel GIF
specialBtn.addEventListener("click", ()=>{
  gifOptions.style.display="none";
  specialPassInput.value="";
  specialPassModal.style.display="flex";
});

// Şifre kontrolü
specialPassBtn.addEventListener("click", ()=>{
  const now=new Date();
  const hour=now.getHours().toString().padStart(2,'0');
  const min=now.getMinutes().toString().padStart(2,'0');
  if(specialPassInput.value === hour+min){
    gifGrid.innerHTML="";
    specialGifs.forEach(url=>{
      const img=document.createElement("img");
      img.src=url;
      img.addEventListener("click", async ()=>{
        await addDoc(messagesRef,{user:username,gifURL:url,createdAt:serverTimestamp()});
        specialPassModal.style.display="none";
        gifModal.style.display="none";
      });
      gifGrid.appendChild(img);
    });
    gifModal.style.display="flex";
    specialPassModal.style.display="none";
  } else alert("Yanlış şifre!");
});

specialPassClose.addEventListener("click", ()=>specialPassModal.style.display="none");
gifCloseBtn.addEventListener("click", ()=>gifModal.style.display="none");

// Mesaj sesleri
const msgSound = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

// Mesajları takip
let displayedMessages = new Set();
onSnapshot(q, snapshot=>{
  snapshot.docChanges().forEach(change => {
    if(change.type==="added"){
      const msg = change.doc.data();
      const msgId = change.doc.id;
      if(displayedMessages.has(msgId)) return;
      displayedMessages.add(msgId);

      const div = document.createElement("div");
      div.classList.add("message", msg.user===username?"me":"other");
      if(msg.text) div.innerText = msg.user + ": " + msg.text;
      if(msg.gifURL){
        const img = document.createElement("img");
        img.src = msg.gifURL;
        div.appendChild(img);
      }
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      if(msg.user!==username && notifEnabled) msgSound.play();
    }
  });
});

// 5 kez GIF alanına tıklayınca ayarlar modalı aç
let clickCount = 0;
gifBtn.addEventListener("click", ()=>{
  clickCount++;
  if(clickCount >=5){
    settingsModal.style.display="flex";
    clickCount=0;
  }
});
settingsClose.addEventListener("click", ()=>settingsModal.style.display="none");

// Bildirim sesi toggle
notifToggle.addEventListener("change", ()=>{
  notifEnabled = notifToggle.checked;
});
</script>
</body>
</html>
